/*
 * jsFace JavaScript Object Oriented Programming Library
 *
 * https://github.com/tannhu/jsface
 *
 * Copyright (c) 2010 Tan Nhu
 * Dual licensed under the MIT and GPL version 2 licenses.
 * $Date: Saturday, March 07 2009 $
 */
(function(m){var c={version:"1.2",namespace:function(a){if(c.isString(a)){var a=a.split("."),b=a.length,e,f=m[a[0]]?m[a[0]]:m[a[0]]={};for(e=0;e<b;e++)if(!c.isIdentifier(a[e]))throw a[e]+" is not a valid namespace alias";for(e=1;e<b;e++)f[a[e]]=f[a[e]]?f[a[e]]:{},f=f[a[e]];return f}return null},each:function(){var a=arguments.length,b,e,f,d,g,h,j;switch(a){case 2:b=arguments[0];f=arguments[1];break;case 3:b=arguments[0];e=arguments[1];f=arguments[2];break;default:return}g=c.isArray(b)||c.isString(b);
h=c.isMap(b);j=c.isFunction(b);if(g||h||j)if(a===2)if(g){a=b.length;for(d=0;d<a;d++)if(g=f(b[d],d),g===!0)break}else for(d in b){if(g=f(d,b[d]),g===!0)break}else if(g){a=b.length;for(d=0;d<a;d++)if(e(b[d],d)&&(g=f(b[d],d),g===!0))break}else for(d in b)if(e(d,b[d])&&(g=f(d,b[d]),g===!0))break},merge:function(){var a=[].concat(Array.prototype.slice.apply(arguments)),b=null,e;switch(a.length){case 0:case 1:break;case 2:e=a[0]||{};a=a[1]||{};c.isMap(e)&&c.isMap(a)&&(b={},c.each(e,function(a,c){b[a]=c}),
c.each(a,function(a,c){b[a]=c}));break;default:e=a.shift(),b=c.merge(e,c.merge.apply(c,a))}return b},global:function(a,b){if(c.isIdentifier(a))return m[a]=b;else if(c.isMap(a))c.each(a,function(a,b){c.global(a,b)});else throw"jsface.global: Invalid global name "+a;},bindProperties:function(a,b){a&&c.isMap(b)&&c.each(b,function(c,b){a[c]=b})},isMap:function(a){return a&&typeof a==="object"&&!(typeof a.length==="number"&&!a.propertyIsEnumerable("length"))},isArray:function(a){return a&&typeof a==="object"&&
typeof a.length==="number"&&!a.propertyIsEnumerable("length")},isFunction:function(a){return a&&typeof a==="function"},isString:function(a){return Object.prototype.toString.apply(a)==="[object String]"},isBoolean:function(a){return Object.prototype.toString.apply(a)==="[object Boolean]"},isNumber:function(a){return Object.prototype.toString.apply(a)==="[object Number]"},isUndefined:function(a){return a===void 0},isNull:function(a){return a===null},isNullOrUndefined:function(a){return a===void 0||
a===null},isEmpty:function(a){return a===void 0||a===null||c.isString(a)&&c.trim(a)===""||c.isArray(a)&&a.length===0||c.isMap(a)&&function(a){for(var c in a)return!1;return!0}(a)},isClass:function(a){return c.isFunction(a)&&a===a.prototype.constructor},isIdentifier:function(a){return/^[a-zA-Z_$]+[0-9a-zA-Z_$]*$/.test(a)},noop:function(){},trim:function(a){for(var b={},e=22;e--;)b[" \n\r\t\u000b\u000c\u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000".charAt(e)]=
!0;c.trim=function(a){if(!c.isString(a))return a;if(String.prototype.trim)return String.prototype.trim.apply(a);for(var d=-1,g=a.length;b[a.charAt(--g)];);for(;d++!==g&&b[a.charAt(d)];);return a.substring(d,g+1)};return c.trim(a)},capitalize:function(a){return c.isString(a)?a.charAt(0).toUpperCase()+a.slice(1).toLowerCase():a},fromString:function(a){for(var a=a.split("."),c=m,e=0,f=a.length-1;e<=f;){c=c[a[e]];if(!c)break;e++}return c},overload:function(){function a(a,b){if(b.length===0)return b;for(var d in b)if(!c.isFunction(b[d]))return b;
if(b.length===1)return b[0];return function(){var c=arguments.length,d=null,j;for(j in b)if(b[j].length===c)return b[j].apply(this,arguments);else b[j].length===0&&(d=b[j]);if(d)return d.apply(this,arguments);else throw"jsface.overload: "+a+"() does not accept "+c+" arguments";}}function b(a,b){function d(c,b){var d;try{return eval("(function() { return function(it) { return ("+c+") === true; }})();")}catch(g){throw"jsface.overload: Invalid validating expression: "+c+" on overloading method "+a+"("+
b+")";}}function g(b,g){var f=[];c.each(b,function(b){var b=c.trim(b),h,j,o,i,k=b.indexOf(":");k===-1?h=b:(h=b.substring(0,k),o=b.substring(k+1,b.length),i=d(o,g));try{j=eval(h)}catch(l){throw"jsface.overload: Type "+h+" is not defined on overloading method "+a+"("+g+")";}f.push({name:h,type:j,expression:o,evaluator:i})});return f}function h(a){if(c.isString(a))return String;if(c.isArray(a))return Array;if(c.isNumber(a))return Number;if(c.isFunction(a))return Function;if(c.isBoolean(a))return Boolean;
try{if(c.isString(a.classMeta.name))return eval(a.classMeta.name)}catch(b){}return Object}function j(b,c,d){var g=a+"(",h;for(h=0;h<d-1;h++)g+=b.types[h].name+": "+c[h]+", ";g+=b.types[d-1].name+": "+c[d-1]+")";return g}function i(b,d,g,f){var k=[],i;c.each(d,function(a){var b;a:{b=a.types;var c,d,e;for(c=0;c<g;c++)if(d=b[c].type,e=f[c],h(e)!==d&&!(e===null&&(d===String||d===Array||d===Object))){b=!1;break a}b=!0}b&&k.push(a)});k.length>1&&c.each(k,function(a,c){for(i=0;i<g;i++){var d=a.types[i].evaluator;
d&&d.call(b,f[i])===!1&&k.splice(c,1)}});if(k.length===1){d=k[0];for(i=0;i<g;i++){var l=d.types[i].evaluator;if(l&&l.call(b,f[i])!==!0)throw j(d,f,g)+". Validating error at parameter "+(i+1)+", expression: "+d.types[i].expression;}return d.fn.apply(b,f)}d=a+"(";for(i=0;i<g-1;i++)d+=f[i]+", ";d+=f[g-1]+"). Check argument types and values.";if(k.length===0)throw"No overloading method matches the call "+d;else throw"Vague arguments on calling "+d;}var k={};c.isFunction(b["0"])&&(k["0"]=[{fn:b["0"]}]);
for(var n in b){if(!c.isFunction(b[n]))return b;if(n!=="0"){var l=n.split(","),m=b[n];if(l.length===1&&!c.fromString(l[0].split(":")[0]))return b;if(l.length!==m.length)throw"jsface.def: Invalid method declaration for "+a+'() at overloading "'+n+'". Actual overloading parameters do not match with their types declaration.';k[l.length]===void 0&&(k[l.length]=[]);l=g(l,n);k[l.length].push({types:l,fn:m})}}return function(b){return function(){var c=arguments.length;if(b[c]!==void 0)return i(this,b[c],
c,arguments);else if(b[0]!==void 0)return b[0][0].fn.apply(this,arguments);else throw a+"() does not accept "+c+" arguments";}}(k)}return function(e,f){return c.isArray(f)?a(e,f):c.isMap(f)?b(e,f):f}}(),def:function(){function a(a){var e;if(!c.isMap(a))throw"jsface.def: Class parameters must be a map object";if(!c.isMap(a.$meta))throw"jsface.def: Invalid parameter $meta, must be a map";if(c.isString(a.$meta.name)){if(!c.isIdentifier(a.$meta.name))try{e=a.$meta.name.split("."),a.$meta.name=e.pop(),
a.$meta.namespace=c.namespace(e.join("."))}catch(f){throw"jsface.def: Class name "+a.$meta.name+" is not valid identifier";}}else throw"jsface.def: Class name is not valid string";}return function(){var b,e,f,d={$meta:1},g,h;switch(arguments.length){case 1:h=arguments[0];break;case 2:h=arguments[1];h.$meta=h.$meta||{};h.$meta.name=arguments[0];break;case 3:h=arguments[2],h.$meta=h.$meta||{},h.$meta.name=arguments[0],h.$meta.parent=arguments[1]}a(h);c.each(c.def.plugins,function(a){d[a]=1});b=h.$meta;
d[b.name]=1;b.singleton===!0?f=e={}:(e=h[b.name]?c.overload(b.name,h[b.name]):function(){},e.name=b.name,e.$meta=b,f=e.prototype);g=c.isArray(g)?b.parent:[b.parent];c.each(g,function(a){c.inherit(e,a)});c.each(h,function(a,g){if(!d[a]&&(f[a]=c.overload(b.name+"."+a,g),c.isFunction(f[a])))f[a].name=a});b.namespace?c.isString(b.namespace)?c.namespace(b.namespace)[b.name]=e:b.namespace[b.name]=e:c.global(b.name,e);c.each(c.def.plugins,function(a,c){c(e,h)});return e}}(),wrap:function(a,b,e,f){function d(){if(f===
!0){if(b.apply(this,arguments)!==!1){var c=a.apply(this,arguments);e.apply(this,arguments);return c}}else return e.apply(this,[a.apply(this,[b.apply(this,arguments)])])}var g={$meta:1,prototype:1};c.each(a,function(a,c){g[a]||(d[a]=c)});return d},pointcuts:function(a,b){if(c.isEmpty(a)||c.isEmpty(b))throw"jsface.pointcuts: Invalid parameters.";var e=c.isFunction(a),f=!e,d=e?a.prototype:a;c.each(b,function(b,e){var j=e.seq===!1?!1:!0,i=e.before||c.noop,k=e.after||c.noop;if(!c.isFunction(i))throw"jsface.pointcuts: Invalid "+
b+".before() pointcut. Must be a function";if(!c.isFunction(k))throw"jsface.pointcuts: Invalid "+b+".after() pointcut. Must be a function";if(f)if(c.isFunction(d[b]))d[b]=c.wrap(d[b],i,k,j);else throw"jsface.pointcuts: "+b+" is not a function, cannot be pointcut";else if(c.isMap(a.$meta)&&c.isIdentifier(a.$meta.name)&&b===a.$meta.name){var n=a.prototype,l=a,j=c.wrap(a,i,k,j);a=a.$meta.namespace?a.$meta.namespace[b]=j:c.global(b,j);a.prototype=n;a.prototype.constructor=j;c.each(l,function(b,c){b!==
"prototype"&&(a[b]=c)})}else if(c.isFunction(d[b]))d[b]=c.wrap(d[b],i,k,j),c.isFunction(a[b])&&(a[b]=d[b]);else throw"jsface.pointcuts: "+b+" is not a function, cannot be pointcut";})},inherit:function(a,b){var e={$meta:1,prototype:1},f;!c.isNullOrUndefined(a)&&!c.isEmpty(b)&&(c.isArray(b)&&c.each(b,function(b){c.inherit(a,b)}),f=c.isClass(a)?a.prototype:a,c.each(b,function(a,g){e[a]||b.hasOwnProperty(a)&&!(c.isClass(b)&&a==="name")&&(f[a]=g)}),c.isClass(b)&&c.each(b.prototype,function(a,b){e[a]||
(f[a]=b)}))},profiling:function(a,b){function e(a,b){return{before:function(){b[a]=b[a]||{};b[a].begin?b[a].begin.push(new Date):b[a].begin=[new Date]},after:function(){b[a].count=(b[a].count||0)+1;var c=b[a].begin.pop();b[a].time=(b[a].time||0)+(new Date-c);b[a].begin.length||delete b[a].begin}}}function f(a,b){var f={},j=a,i;if(c.isClass(a)&&(j=a.prototype,a.$meta&&a.$meta.name))i=a.$meta.name,f[a.$meta.name]=e(i,b);c.each(j,function(a,d){c.isFunction(d)&&(f[a]=e(a,b))});return f}c.profiling=function(a,
b){if(!c.isMap(b))throw"jsface.profile: profiling repository must be a map/object";c.pointcuts(a,f(a,b))};return c.profiling(a,b)},fireParentReady:function(a,b){function e(a){c.isArray(a)&&c.each(a,function(a){e(a)});if(a&&a.$meta&&(a.$meta.ready&&f.push({clazz:a,ready:a.$meta.ready}),a=a.$meta.parent))a=c.isArray(a)?a:[a],c.each(a,function(a){e(a)})}var f=[],d;for(e(b.$meta.parent);f.length;)d=f.pop(),d.ready.call(d.clazz,a,b)}};c.def.plugins={statics:function(a,b){b.$meta.singleton||c.each(b.$meta.statics,
function(e){if(c.isIdentifier(e)&&b[e])a[e]=b[e];else throw"jsface.def: Invalid static method/property "+e+" in declaring class "+b.$meta.name;})},ready:function(a,b){c.fireParentReady(a,b);c.isFunction(b.$meta.ready)&&b.$meta.ready.call(a,a,b)},pointcuts:function(a,b){c.isMap(b.$meta.pointcuts)&&c.pointcuts(a,b.$meta.pointcuts)}};m.jsface=c})(this);